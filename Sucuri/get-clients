#!/usr/bin/php5
<?php
/*
   +----------------------------------------------------------------------+
   | get-clients.php                                                      |
   +----------------------------------------------------------------------+
   | returns an array of clientIds matching the desired groupId read from |
   | a file on disk.                                                      |
   +----------------------------------------------------------------------+
   | Author: Gbenga Ojo <gbenga.a.ojo@gmail.com>                          |
   | Origin Date: Feb 13, 2017                                            | 
   +----------------------------------------------------------------------+
 */

class GetClients {
   const CLIENT_ID = 0;
   const TIMESTAMP = 1;
   const GROUP_ID = 2;
   const STATUS = 3;
   const MESSAGE_ID = 4;

   protected $csv;

   public function __construct($filename = 'input.csv') {
      // open file
      $fh = fopen($filename, 'r');

      if ($fh) {
         while (($line = fgets($fh)) !== false)
            $this->csv[] = $line;
      } else {
         exit('Error opening file');
      }
   }

   /**
    * returns an array of clientIds
    *
    * @param: (string) $groupId
    * @throws: (Exception)
    * @return: (array)
    */
   public function getClientsByGroupId($groupId) {
      // validate data
      $valid = $this->validateFields();

      foreach ($this->csv as $line) {
         $fields = explode(",", $line);

         if (!$valid) {
            throw new ErrorException('Corrupt CSV data. Exiting');
         }

         if ($fields[self::GROUP_ID] == $groupId)
            $clientIds[] = $fields[self::CLIENT_ID];
      }

      return $clientIds;
   }

   /**
    * validate CSV fields
    *
    * @return (bool)
    */
   public function validateFields() {
      foreach ($this->csv as $line) {
         $fields = explode(",", $line);

         // test for empty fields
         foreach ($fields as $field) {
            if (empty($field)) {
               return false;
               break;
            }
         }

         // validate clientId
         if (!is_string($fields[self::CLIENT_ID]) || strlen(trim($fields[self::CLIENT_ID] > 100)))
            return false;
         // validate timestamp (neg ts debatable)
         if (!is_numeric(trim($fields[self::TIMESTAMP])) || trim($fields[self::TIMESTAMP]) < 0)
            return false;
         // validate group id
         if (!in_array(trim($fields[self::GROUP_ID]), array('foo', 'bar', 'fizz', 'buzz')))
            return false;
         // validate status
         if (!is_numeric(trim($fields[self::STATUS])))
            return false;
         // validate message id
         if (!is_numeric(trim($fields[self::MESSAGE_ID])))
            return false;
      }

      // if all fields in all lines are good...
      return true;
   }
}


$usage_msg = <<<EOT

Usage:
get-clients FILENAME TYPE
   TYPE:
      --foo
      --bar
      --fizz
      --buzz

EOT;

$prog_name = array_shift($argv);

$filename = array_shift($argv);
if (!file_exists($filename)) {
   print 'Error finding file';
   print($usage_msg);
   exit(0);
}

$arg = array_shift($argv);
switch ($arg) {
   case '--foo' :
      $groupId = 'foo';
   break;

   case '--bar' :
      $groupId = 'bar';
   break;

   case '--fizz' :
      $groupId = 'fizz';
   break;

   case '--buzz' :
      $groupId = 'buzz';
   break;

   default :
      print($usage_msg);
      exit(0);
}





$results = array();
$obj = new GetClients($filename);
try {
   $results = $obj->getClientsByGroupId($groupId);
   echo "\n\nClients matching groupId \"$groupId\":\n";
   print_r($results);

} catch (ErrorException $e) {
   print('Message: ' . $e->getMessage() . "\n");
   print("Stack Trace:\n " . $e->getTraceAsString() . "\n");
   exit(0);
}
